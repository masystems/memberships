{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block header %}
    <link rel="stylesheet" type="text/css" href="{% static 'assets/libs/datatables.net-bs4/css/dataTables.bootstrap4.css' %}">
{% endblock %}

{% block content %}

{% include 'comments-modal.html' %}

<!-- ============================================================== -->
<!-- Bread crumb and right sidebar toggle -->
<!-- ============================================================== -->
<div class="page-breadcrumb">
    <div class="row">
        <div class="col-md-5 align-self-center">
            <h4 class="page-title">{{ membership_package }} Members Detailed</h4>
            <div class="d-flex align-items-center">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                        {% if membership_packages %}
                            <li class="breadcrumb-item"><a href="{% url 'membership' %}">Membership</a></li>
                        {% endif %}
                        <li class="breadcrumb-item active" aria-current="page">Members Detailed</li>
                    </ol>
                </nav>
            </div>
        </div>
        <div class="col-md-7 align-self-center d-none d-md-block">

        </div>
    </div>
</div>
<!-- ============================================================== -->
<!-- End Bread crumb and right sidebar toggle -->
<!-- ============================================================== -->
<!-- ============================================================== -->
<!-- Container fluid  -->
<!-- ============================================================== -->
<div class="container-fluid">
    <!-- Row -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">{{ package.organisation_name }} Members</h4>
                    <div class="mb-2">
                        Toggle columns: 
                        <a href="#!" class="toggle-vis name-lnk" data-column="2"><button class="btn btn-info" id="name-btn">Name</button></a>
                        <a href="#!" class="toggle-vis email-lnk" data-column="3"><button class="btn btn-info" id="email-btn">Email</button></a>
                        <a href="#!" class="toggle-vis address-lnk" data-column="4"><button class="btn btn-info" id="address-btn">Address</button></a>
                        <a href="#!" class="toggle-vis contact-lnk" data-column="5"><button class="btn btn-info" id="contact-btn">Contact</button></a>
                        <a href="#!" class="toggle-vis mem-lnk" data-column="6"><button class="btn btn-info" id="mem-btn">Membership Type</button></a>
                        <a href="#!" class="toggle-vis pay-lnk" data-column="7"><button class="btn btn-info" id="pay-btn">Payment Type</button></a>
                        <a href="#!" class="toggle-vis bill-lnk" data-column="8"><button class="btn btn-info" id="bill-btn">Billing Interval</button></a>
                        <a href="#!" class="toggle-vis comments-lnk" data-column="9"><button class="btn btn-info" id="comments-btn">Comments</button></a>
                        <a href="#!" class="toggle-vis date-lnk" data-column="10"><button class="btn btn-info" id="date-btn">Date Created</button></a>
                    </div>
                    <div class="table-responsive">
                        <table id="show_hide_col" class="table table-striped table-bordered display no-wrap"
                            style="width:100%">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Address</th>
                                    <th>Contact</th>
                                    <th>Membership Type</th>
                                    <th>Payment Method</th>
                                    <th>Billing Interval</th>
                                    <th>Comments</th>
                                    <th>Membership Start</th>
                                    <th>Membership Expiry</th>
                                </tr>
                            </thead>

                            <tfoot>
                                <tr>
                                    <th>Action</th>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Address</th>
                                    <th>Contact</th>
                                    <th>Membership Type</th>
                                    <th>Payment Method</th>
                                    <th>Billing Interval</th>
                                    <th>Comments</th>
                                    <th>Membership Start</th>
                                    <th>Membership Expiry</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
<!--                    {% if membership_package.bolton != "none" %}-->
<!--                    <hr>-->
<!--                    <h4>{{ membership_package.bolton|title }} Bolton Data</h4>-->
<!--                    {% endif %}-->
<!--                    <div class="table-responsive">-->
<!--                        <table id="show_hide_col" class="table table-striped table-bordered display no-wrap"-->
<!--                            style="width:100%">-->
<!--                            <thead>-->
<!--                                <tr>-->
<!--                                    <th>Member Name</th>-->
<!--                                    {% for col in bolton_columns %}-->
<!--                                        <th>{{ col.verbose_name|title }}</th>-->
<!--                                    {% endfor %}-->
<!--                                </tr>-->
<!--                            </thead>-->
<!--                            <tbody>-->
<!--                                {% for member in bolton %}-->
<!--                                    <tr>-->
<!--                                        <td>{{ member.subscription.member.user_account.get_full_name }}</td>-->
<!--                                        {% for item, value in member.attrs %}-->
<!--                                            {% if forloop.first or item == 'id' or item == 'subscription_id' %}-->
<!--                                            {% else %}-->
<!--                                                <td>-->
<!--                                                    {% if value == True %}-->
<!--                                                        <i class="fad fa-check text-success"></i>-->
<!--                                                    {% elif value == False %}-->
<!--                                                        <i class="fad fa-times text-danger"></i>-->
<!--                                                    {% elif value == None %}-->
<!--                                                        &lt;!&ndash; Blank &ndash;&gt;-->
<!--                                                    {% else %}-->
<!--                                                        {{ value }}-->
<!--                                                    {% endif %}-->
<!--                                                </td>-->
<!--                                            {% endif %}-->
<!--                                        {% endfor %}-->
<!--                                    </tr>-->
<!--                                {% endfor %}-->
<!--                            </tbody>-->
<!--                            <tfoot>-->
<!--                                <tr>-->
<!--                                    <th>Member Name</th>-->
<!--                                    {% for col in bolton_columns %}-->
<!--                                        <th>{{ col.verbose_name|title }}</th>-->
<!--                                    {% endfor %}-->
<!--                                </tr>-->
<!--                            </tfoot>-->
<!--                        </table>-->
<!--                    </div>-->
                </div>
            </div>
        </div>
    </div>
    <!-- End Row -->

</div>
<!-- ============================================================== -->
<!-- End Container fluid  -->
<!-- ============================================================== -->
{% endblock %}

{% block footer %}
    <script src="{% static 'assets/libs/datatables/media/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'dist/js/pages/datatable/custom-datatable.js' %}"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.flash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.print.min.js"></script>
    <script>
        var members_table = $('#show_hide_col').DataTable({
            "processing": true,
            "serverSide": true,
            "bSort": false,
            "ajax": "{% url 'get_members_detailed' membership_package.organisation_name %}",
            "columns": [
                { data: "action" },
                { data: "id" },
                { data: "name" },
                { data: "email" },
                { data: "address" },
                { data: "contact" },
                { data: "membership_type" },
                { data: "payment_method" },
                { data: "billing_interval" },
                { data: "comments" },
                { data: "membership_start" },
                { data: "membership_expiry" },
            ],
            colReorder: true,
            dom: "Bfrltip",
            buttons: [
                'copy', 'csv', 'excel', 'pdf', 'print'
            ],
            columnDefs: [
                {
                    render: function (data, type, full, meta) {
                        return "<div class='text-wrap width-200'>" + data + "</div>";
                    },
                    targets: 9
                }
            ]
        });


        $('a.toggle-vis').on('click', function(e) {
            e.preventDefault();

            // Get the column API object
            /*var column = table.column($(this).attr('data-column'));*/
            var column = $('#show_hide_col').dataTable().api().column($(this).attr('data-column'));
            // Toggle the visibility
            column.visible(!column.visible());

            // See which link has been clicked
            if ($(this).hasClass('name-lnk')) {
                // Toggle colour of button when pressed
                if ($('#name-btn').hasClass('btn-info')) {
                    $('#name-btn').removeClass('btn-info')
                    $('#name-btn').addClass('btn-light')
                }
                else if ($('#name-btn').hasClass('btn-light')) {
                    $('#name-btn').removeClass('btn-light')
                    $('#name-btn').addClass('btn-info')
                }
            }
            else if ($(this).hasClass('email-lnk')) {
                // Toggle colour of button when pressed
                if ($('#email-btn').hasClass('btn-info')) {
                    $('#email-btn').removeClass('btn-info')
                    $('#email-btn').addClass('btn-light')
                }
                else if ($('#email-btn').hasClass('btn-light')) {
                    $('#email-btn').removeClass('btn-light')
                    $('#email-btn').addClass('btn-info')
                }
            }
            else if ($(this).hasClass('address-lnk')) {
                // Toggle colour of button when pressed
                if ($('#address-btn').hasClass('btn-info')) {
                    $('#address-btn').removeClass('btn-info')
                    $('#address-btn').addClass('btn-light')
                }
                else if ($('#address-btn').hasClass('btn-light')) {
                    $('#address-btn').removeClass('btn-light')
                    $('#address-btn').addClass('btn-info')
                }
            }
            else if ($(this).hasClass('contact-lnk')) {
                // Toggle colour of button when pressed
                if ($('#contact-btn').hasClass('btn-info')) {
                    $('#contact-btn').removeClass('btn-info')
                    $('#contact-btn').addClass('btn-light')
                }
                else if ($('#contact-btn').hasClass('btn-light')) {
                    $('#contact-btn').removeClass('btn-light')
                    $('#contact-btn').addClass('btn-info')
                }
            }
            else if ($(this).hasClass('mem-lnk')) {
                // Toggle colour of button when pressed
                if ($('#mem-btn').hasClass('btn-info')) {
                    $('#mem-btn').removeClass('btn-info')
                    $('#mem-btn').addClass('btn-light')
                }
                else if ($('#mem-btn').hasClass('btn-light')) {
                    $('#mem-btn').removeClass('btn-light')
                    $('#mem-btn').addClass('btn-info')
                }
            }
            else if ($(this).hasClass('pay-lnk')) {
                // Toggle colour of button when pressed
                if ($('#pay-btn').hasClass('btn-info')) {
                    $('#pay-btn').removeClass('btn-info')
                    $('#pay-btn').addClass('btn-light')
                }
                else if ($('#pay-btn').hasClass('btn-light')) {
                    $('#pay-btn').removeClass('btn-light')
                    $('#pay-btn').addClass('btn-info')
                }
            }
            else if ($(this).hasClass('bill-lnk')) {
                // Toggle colour of button when pressed
                if ($('#bill-btn').hasClass('btn-info')) {
                    $('#bill-btn').removeClass('btn-info')
                    $('#bill-btn').addClass('btn-light')
                }
                else if ($('#bill-btn').hasClass('btn-light')) {
                    $('#bill-btn').removeClass('btn-light')
                    $('#bill-btn').addClass('btn-info')
                }
            }
            else if ($(this).hasClass('comments-lnk')) {
                // Toggle colour of button when pressed
                if ($('#comments-btn').hasClass('btn-info')) {
                    $('#comments-btn').removeClass('btn-info')
                    $('#comments-btn').addClass('btn-light')
                }
                else if ($('#comments-btn').hasClass('btn-light')) {
                    $('#comments-btn').removeClass('btn-light')
                    $('#comments-btn').addClass('btn-info')
                }
            }
            else if ($(this).hasClass('date-lnk')) {
                // Toggle colour of button when pressed
                if ($('#date-btn').hasClass('btn-info')) {
                    $('#date-btn').removeClass('btn-info')
                    $('#date-btn').addClass('btn-light')
                }
                else if ($('#date-btn').hasClass('btn-light')) {
                    $('#date-btn').removeClass('btn-light')
                    $('#date-btn').addClass('btn-info')
                }
            }
        });
    </script>
    <script>
        <!-- edit comments -->
        var editComment = function (sub_id) {
            $.ajax({
                url:"/membership/edit-sub-comment/"+sub_id,
                type:"GET",
                success: function (data){
                    var result = JSON.parse(data);
                    if (result['status'] == "fail") {
                        errorMsg(result['message']);
                    } else {
                        $("textarea#commentField").val(result['comment']);
                        $("#save-comment").val(sub_id);
                        $('#comment-modal').modal('toggle');
                    }
                },
                error:function (er) {
                    errorMsg("Failed to edit comment!",er);
                }
            });

       }
       $("#save-comment").click(function(e){
            sub_id = $("#save-comment").val();
            $.ajax({
                url:"/membership/edit-sub-comment/"+sub_id,
                type: 'POST',
                dataType: 'text',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: $('#commentForm').serialize(),
                beforeSend: function() {
                },
                success: function(data) {
                    var result = JSON.parse(data);
                    if (result['status'] == "fail") {
                        errorMsg(result['message']);
                    } else {
                        $('#comment-modal').modal('toggle');
                        infoMsg(result['message']);
                        members_table.ajax.reload()
                    }
                 },
                error: function(jqXHR, textStatus, errorThrown){
                }
            });
        });
    </script>
{% endblock %}